<% @warehouses = Warehouse.all %>
<div class="row wrapper border-bottom white-bg page-heading">
  <div class="col-sm-6">
    <h2>Stock Reports</h2>
    <ol class="breadcrumb">
      <li>
        <a href="/">Home</a>
      </li>
      <li>
        <a href="/stock_reports">Stock Reports</a>
      </li>
      <li class="active">
        <strong>Stock Status By Store</strong>
      </li>
    </ol>
  </div>
  <div class="col-sm-6">
    <div class="title-action">
    </div>
  </div>
</div>
<div class="ibox float-e-margins">
  <div class="ibox-content">
      <%= form_tag( "/stock_reports/stock_status_by_store" ,{ class: 'form-inline', style: 'display: inline-block;', role: 'form', method: 'GET'}) do %>

      	<div class="form-group">
          <%= label_tag :hub, "Hub", { :class => ' control-label'} %>

          <div class="">
             <%= collection_select :hub_id,:id,Hub.order(:name), :id, :name, {:selected => params[:hub],  :prompt => true, :required => true},  {  :id => 'hub_select',:name => 'hub' ,:class => 'form-control' }%>
          </div>
        </div>
        <div class="form-group">
          <%= label_tag :program, "warehouse", { :class => ' control-label', :required => true } %>

          <div class="">
             <%= collection_select :warehouse_id,:id,@warehouses.select{|w| w.hub_id == "#{:hub_select}"}, :id, :name, { :prompt => true, :required => true}, {:id => 'warehouse_select',:name => 'warehouse' ,:class => 'form-control' }%>
          </div>
        </div>
        <div class="form-group">
          <%= label_tag :as_of_date, "As of date", { :class => ' control-label'} %>
          <div class="">
            <%= text_field_tag :as_of_date, params[:as_of_date], { id: 'dispatched-date-picker',class: 'form-control datepicker', :required => true}  %>
          </div>
        </div>
        <div class="form-group">
          <label for=""></label>
          <div>
              <input type="submit" name="filter" value="Go" class="btn btn-sm btn-primary" />
          </div>
        </div>

        <% end %>


  </div>
</div>

<div class="ibox float-e-margins">
  <div class="ibox-content">

    <table class="table table-striped cats-datatable">
      <thead>
        <th>Store No.</th>
        <th>Project code / SI / Donor</th>
        <th>Commodity Source</th>   
        <th>Commodity Category</th>         
        <th>Commodity</th>
        <th>Previous Stock Balance(MT)</th>
        <th>Cumulative Receipts</th>
        <th>Cumulative Dispatches</th>
        <th>Loss in MT</th>
        <th>Physical Stock</th>
        <th>Committed Stock</th>
        <th>Free Stock</th>
      </thead>

      <tbody>      
        <% @stock_status.each do |stock| %>
            <tr>
                <td><%= stock['store'] %></td>
                <td><%= stock['project_code'] %></td>
                <td><%= stock['commodity_source'] %></td>
                <td><%= stock['commodity_category'] %></td>
                <td><%= stock['commodity'] %></td>
                <td style="text-align:right;"><%= number_with_delimiter(stock['prev_balance'],:delimiter => ',') %></td> 
                <td style="text-align:right;"><%= number_with_delimiter(stock['receipt_balance'],:delimiter => ',') %></td> 
                <td style="text-align:right;"><%= number_with_delimiter(stock['dispatch_balance'],:delimiter => ',') %></td> 
                <td style="text-align:right;">N/A</td> 
                <td style="text-align:right;"><%= number_with_delimiter(stock['current_balance'],:delimiter => ',') %></td> 
                <td style="text-align:right;">N/A</td> 
                <td style="text-align:right;">N/A</td>             
            </tr>
        <% end %>
      </tbody>
    </table>        
    
  </div>
</div>

<script>
 $(document).ready(function () {
      
       populate($('#hub_select').val());

      $('#hub_select').change(function(){
        populate($(this).val());
      });


    });

function populate(id)
{
  var hub_id =id;
         var EMPTY_OPTION = '<option value="">-- Choose --</option>';
        var warehouses = <%= @warehouses.to_json.html_safe %>   
        var warehouses_in_hub = $.grep(warehouses, function (elem) {
          return elem.hub_id == hub_id
        });
    
        var warehouse_options = $.map(warehouses_in_hub, function (val) {
          return '<option value="' + val.id + '">' + val.name + '</option>';
        });
       warehouse_options.unshift(EMPTY_OPTION);
       $('#warehouse_select').html(warehouse_options);
        $('#warehouse_select').val(<%= params[:warehouse] %>)  
}
    </script>